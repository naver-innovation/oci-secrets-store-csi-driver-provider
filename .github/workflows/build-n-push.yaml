name: BuildnPush

on:
  workflow_call:
    inputs:
      IMAGE_TAG:
        required: false
        type: string
        default: ${{ github.ref_name }}
    secrets:
      IMAGE_REGISTRY:
        required: true
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
    outputs:
      IMAGE_PATH:
        description: "Image Path"
        value: ${{ jobs.create-manifest.outputs.IMAGE_PATH }}

env:
  IMAGE_REPO_NAME: oci-secrets-store-csi-driver-provider
  IMAGE_TAG: ${{ inputs.IMAGE_TAG }}

jobs:
  unit-tests:
    uses: ./.github/workflows/unit-tests.yaml

  build-amd64:
    needs: [unit-tests]
    runs-on: arc-amd64
    name: Build linux/amd64 image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.IMAGE_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push amd64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO_NAME }}:${{ env.IMAGE_TAG }}-amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

  build-arm64:
    needs: [unit-tests]
    runs-on: arc-arm64
    name: Build linux/arm64 image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.IMAGE_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push arm64 image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO_NAME }}:${{ env.IMAGE_TAG }}-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

  create-manifest:
    needs: [build-amd64, build-arm64]
    runs-on: arc-arm64
    name: Create and push multi-arch manifest
    outputs:
      IMAGE_PATH: ${{ steps.set-image-path.outputs.IMAGE_PATH }}
    steps:
      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.IMAGE_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create and push multi-arch manifest
        run: |
          IMAGE_BASE="${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO_NAME }}"
          docker buildx imagetools create \
            --tag "${IMAGE_BASE}:${{ env.IMAGE_TAG }}" \
            --tag "${IMAGE_BASE}:latest" \
            "${IMAGE_BASE}:${{ env.IMAGE_TAG }}-amd64" \
            "${IMAGE_BASE}:${{ env.IMAGE_TAG }}-arm64"

      - name: Set IMAGE_PATH output
        id: set-image-path
        run: |
          echo "IMAGE_PATH=${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT
